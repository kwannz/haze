# Haze-Library CI/CD Pipeline
# Tests Rust code, builds Python wheels, and runs integration tests

name: CI

on:
  push:
    branches: [main, master, develop]
    tags:
      - 'v*'  # Trigger on version tags
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================
  # Rust Testing & Linting (Matrix)
  # ============================================================
  rust-test:
    name: Rust Tests (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: ['1.75.0', stable, beta]
        exclude:
          # Reduce CI time by excluding some combinations
          - os: macos-latest
            rust: beta
    defaults:
      run:
        working-directory: ./rust

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-
            ${{ runner.os }}-cargo-

      - name: Check formatting
        if: matrix.rust == 'stable'
        run: cargo fmt --all -- --check

      - name: Run clippy
        if: matrix.rust == 'stable'
        run: cargo clippy --all-targets --locked -- -D warnings

      - name: Run tests
        run: cargo test --locked --verbose

      - name: Build release
        run: cargo build --release --locked

  # ============================================================
  # Python Wheel Building (Linux)
  # ============================================================
  build-linux:
    name: Build Linux Wheels
    runs-on: ubuntu-latest
    needs: rust-test
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel
        working-directory: ./rust
        run: maturin build --release --features python -o dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-py${{ matrix.python-version }}
          path: rust/dist/*.whl

  # ============================================================
  # Python Wheel Building (macOS)
  # ============================================================
  build-macos:
    name: Build macOS Wheels
    runs-on: macos-latest
    needs: rust-test
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
        target: [x86_64-apple-darwin, aarch64-apple-darwin]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel
        working-directory: ./rust
        run: maturin build --release --features python --target ${{ matrix.target }} -o dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-macos-${{ matrix.target }}-py${{ matrix.python-version }}
          path: rust/dist/*.whl

  # ============================================================
  # Python Wheel Building (Windows)
  # ============================================================
  build-windows:
    name: Build Windows Wheels
    runs-on: windows-latest
    needs: rust-test
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel
        working-directory: ./rust
        run: maturin build --release --features python -o dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-windows-py${{ matrix.python-version }}
          path: rust/dist/*.whl

  # ============================================================
  # Integration Tests
  # ============================================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-linux
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel-linux-py${{ matrix.python-version }}
          path: dist

      - name: Install wheel and test dependencies
        run: |
          pip install dist/*.whl
          pip install pytest pytest-cov pandas numpy

      - name: Install optional dependencies
        run: |
          pip install polars || true
          pip install torch --index-url https://download.pytorch.org/whl/cpu || true

      - name: Run Python tests with coverage
        run: |
          pytest tests/ -v --cov=haze_library --cov-report=xml --cov-report=term-missing || true
          python -c "import haze_library; print('Import successful')"
          python -c "
          import numpy as np
          from haze_library import np_ta
          close = np.random.randn(100) + 100
          sma = np_ta.sma(close, 20)
          rsi = np_ta.rsi(close, 14)
          print(f'SMA shape: {sma.shape}, RSI shape: {rsi.shape}')
          print('NumPy tests passed!')
          "
          python -c "
          import pandas as pd
          import haze_library
          df = pd.DataFrame({'close': [100, 101, 102, 103, 104] * 10})
          sma = df['close'].ta.sma(5)
          print(f'Pandas accessor test: {sma.iloc[-1]:.2f}')
          print('Pandas tests passed!')
          "

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ============================================================
  # Release (on tag push)
  # ============================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows, integration-test]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.whl
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Publish to PyPI (on tag push)
  # ============================================================
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows, integration-test]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install maturin
        run: pip install maturin

      - name: Build source distribution
        working-directory: ./rust
        run: maturin sdist -o ../dist

      - name: List distributions
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          # For trusted publishing, no password needed
          # If not using trusted publishing, use:
          # password: ${{ secrets.PYPI_API_TOKEN }}
