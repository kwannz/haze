# Haze-Library CI/CD Pipeline
# Tests Rust code, builds Python wheels, and runs integration tests

name: CI

on:
  push:
    branches: [main, master, develop]
    tags:
      - 'v*'  # Trigger on version tags
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================
  # Rust Testing & Linting (Matrix)
  # ============================================================
  rust-test:
    name: Rust Tests (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]
        exclude:
          # Reduce CI time by excluding some combinations
          - os: macos-latest
            rust: beta
    defaults:
      run:
        working-directory: ./rust

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-
            ${{ runner.os }}-cargo-

      - name: Check formatting
        if: matrix.rust == 'stable'
        run: cargo fmt --all -- --check

      - name: Run clippy
        if: matrix.rust == 'stable'
        run: cargo clippy --all-targets -- -D clippy::all

      - name: Run tests
        run: cargo test --verbose

      - name: Build release
        run: cargo build --release

  # ============================================================
  # Python Wheel Building (Linux)
  # ============================================================
  build-linux:
    name: Build Linux Wheels
    runs-on: ubuntu-latest
    needs: rust-test
    strategy:
      matrix:
        python-version: ['3.14']

    steps:
      - uses: actions/checkout@v4

      - name: Build wheel (manylinux)
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -o dist -i python${{ matrix.python-version }}
          manylinux: 2014
          working-directory: .

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-py${{ matrix.python-version }}
          path: dist/*.whl

  # ============================================================
  # Python Wheel Building (Linux aarch64)
  # ============================================================
  build-linux-aarch64:
    name: Build Linux Wheels (aarch64)
    runs-on: ubuntu-latest
    needs: rust-test
    strategy:
      matrix:
        python-version: ['3.14']

    steps:
      - uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build wheel (manylinux aarch64)
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -o dist -i python${{ matrix.python-version }}
          manylinux: 2014
          target: aarch64-unknown-linux-gnu
          working-directory: .

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-aarch64-py${{ matrix.python-version }}
          path: dist/*.whl

  # ============================================================
  # Python Wheel Building (macOS)
  # ============================================================
  build-macos:
    name: Build macOS Wheels
    runs-on: ${{ matrix.os }}
    needs: rust-test
    strategy:
      matrix:
        python-version: ['3.14']
        os: [macos-14]  # ARM only

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -o dist
          rust-toolchain: stable
          working-directory: .

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-macos-${{ matrix.os }}-py${{ matrix.python-version }}
          path: dist/*.whl

  # Windows builds removed - only supporting Linux and macOS

  # ============================================================
  # Source Distribution (sdist)
  # ============================================================
  build-sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    needs: rust-test

    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: -o dist
          working-directory: .

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  # ============================================================
  # Integration Tests
  # ============================================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-linux
    strategy:
      matrix:
        python-version: ['3.14']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel-linux-py${{ matrix.python-version }}
          path: dist

      - name: Install wheel and test dependencies
        run: |
          pip install dist/*.whl
          pip install pytest pytest-cov pandas numpy

      - name: Check pandas-ta compatibility map
        if: matrix.python-version == '3.14'
        run: |
          pip install pandas-ta --no-deps
          pip install tqdm
          python scripts/check_pandas_ta_compat.py

      - name: Install optional dependencies
        run: |
          pip install polars || true
          pip install torch --index-url https://download.pytorch.org/whl/cpu || true

      - name: Run Python tests with coverage
        continue-on-error: true  # Don't block release on integration test failures
        run: |
          pytest tests/ -v --cov=haze_library --cov-report=xml --cov-report=term-missing || true
          python -c "import haze_library; print('Import successful')"
          python -c "
          import numpy as np
          from haze_library import np_ta
          close = np.random.randn(100) + 100
          sma = np_ta.sma(close, 20)
          rsi = np_ta.rsi(close, 14)
          print(f'SMA shape: {sma.shape}, RSI shape: {rsi.shape}')
          print('NumPy tests passed!')
          " || true
          python -c "
          import pandas as pd
          import haze_library
          df = pd.DataFrame({'close': [100, 101, 102, 103, 104] * 10})
          sma = df['close'].haze.sma(5)
          print(f'Pandas accessor test: {sma.iloc[-1]:.2f}')
          print('Pandas tests passed!')
          " || true

      - name: Smoke test (must pass)
        run: |
          python -c "import haze_library; print(f'haze_library {haze_library.__version__} import OK')"
          python - <<'PY'
          import numpy as np
          import haze_library

          close = np.random.randn(256).astype(np.float64) + 100.0
          sma = haze_library.np_ta.sma(close, 20)
          rsi = haze_library.np_ta.rsi(close, 14)

          assert len(sma) == len(close)
          assert len(rsi) == len(close)
          print("NumPy smoke OK")
          PY
          python - <<'PY'
          import pandas as pd
          import haze_library

          df = pd.DataFrame({"close": [100, 101, 102, 103, 104] * 60})
          out = df["close"].haze.sma(5)
          assert len(out) == len(df)
          assert out.notna().any()
          print("Pandas accessor smoke OK")

          ui = df.haze.ulcer_index(14)
          assert len(ui) == len(df)
          assert ui.notna().any()
          print("Dynamic accessor smoke OK")
          PY

      - name: Upload coverage
        if: matrix.python-version == '3.14'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ============================================================
  # Release (on tag push)
  # ============================================================
  release-preflight:
    name: Release Preflight
    runs-on: ubuntu-latest
    needs:
      [build-linux, build-linux-aarch64, build-macos, build-sdist, integration-test]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Validate versions and artifacts
        run: |
          python scripts/release_preflight.py \
            --expected-version "${GITHUB_REF_NAME#v}" \
            --dist-dir dist \
            --require-full-matrix

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [release-preflight]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Publish to PyPI (on tag push)
  # ============================================================
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [release-preflight]
    if: startsWith(github.ref, 'refs/tags/v')

    environment: pypi

    permissions:
      id-token: write  # Required for trusted publishing
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: List distributions
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          # For trusted publishing, no password needed
          # If not using trusted publishing, use:
          # password: ${{ secrets.PYPI_API_TOKEN }}
